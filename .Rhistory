jsonData <- fromJSON(paste("https://www.strava.com/api/v3/segments/explore?bounds=37.621362,-122.505373,37.64203,-122.465977&per_page=200&access_token=",sig$credentials$access_token,sep=''))
jsonData
paste("https://www.strava.com/api/v3/segments/explore?bounds=48.365346312725784,16.05521538437506,48.1855069,16.322995300000002&per_page=200&access_token=",sig$credentials$access_token,sep='')
jsonData <- fromJSON(paste("https://www.strava.com/api/v3/segments/explore?bounds=48.365346312725784,16.05521538437506,48.1855069,16.322995300000002&per_page=200&access_token=",sig$credentials$access_token,sep=''))
jsonData
GET(paste("https://www.strava.com/api/v3/segments/explore?bounds=48.365346312725784,16.05521538437506,48.1855069,16.322995300000002&per_page=200&access_token=",sig$credentials$access_token,sep=''))
GET(paste("https://www.strava.com/api/v3/segments/explore?bounds=48.365346312725784,16.05521538437506,48.1855069,16.322995300000002&per_page=200&access_token=",sig$credentials$access_token,sep=''))
GET(paste("https://www.strava.com/api/v3/segments/explore?bounds=37.621362,-122.505373,37.64203,-122.465977&per_page=200&access_token=",sig$credentials$access_token,sep=''))
test <- GET(paste("https://www.strava.com/api/v3/segments/explore?bounds=37.621362,-122.505373,37.64203,-122.465977&per_page=200&access_token=",sig$credentials$access_token,sep=''))
str(test)
names(test)
test$content
jsonData <- fromJSON(paste("https://www.strava.com/api/v3/segments/explore?bounds=47.53853,18.91571,47.48055,19.10797&access_token=",sig$credentials$access_token,sep=''), flatten = TRUE)
jsonData
jsonData <- fromJSON(paste("https://www.strava.com/api/v3/segments/explore?bounds=47.53853,18.91571,47.48055,19.10797&access_token=",sig$credentials$access_token,sep=''))
jsonData
str(jsonData)
test <- GET(paste("https://www.strava.com/api/v3/segments/explore?bounds=47.53853,18.91571,47.48055,19.10797&access_token=",sig$credentials$access_token,sep=''))
test
str(test)
GET(paste("https://www.strava.com/api/v3/segments/explore?bounds=37.821362, -122.505373, 37.842038, -122.465977&access_token=",sig$credentials$access_token,sep=''))$url
library(httr)
library(jsonlite)
#
my_app = oauth_app('strava', key='23914', secret='803d437f199924a2ed3f31ff135c84d29b528ca6')
my_endpoint <- oauth_endpoint(
request = NULL,
authorize = "https://www.strava.com/oauth/authorize",
access = "https://www.strava.com/oauth/token"
)
sig <- oauth2.0_token(my_endpoint,
my_app, scope = "view_private",
type = NULL,
use_oob = FALSE,
as_header = FALSE,
use_basic_auth = FALSE,
cache = FALSE)
get_base <- function(resource, parameters){
_url = paste(acc_point, resource, '?acces_token=', token, parameters, sep='')
return(fromJSON(_url))
}
get_base <- function(resource, parameters){
_url = paste(acc_point, resource, '?acces_token=', token, parameters, sep='')
return(fromJSON(_url))
}
get_base <- function(resource, parameters){
_url <- paste(acc_point, resource, '?acces_token=', token, parameters, sep='')
return(fromJSON(_url))
}
get_base <- function(resource, parameters){
HTTPreq <- paste(acc_point, resource, '?acces_token=', token, parameters, sep='')
return(fromJSON(HTTPreq))
}
test <- getbase('/activities', '&include_all_efforts=1')
GET_base <- function(resource, parameters){
HTTPreq <- paste(acc_point, resource, '?acces_token=', token, parameters, sep='')
return(fromJSON(HTTPreq))
}
test <- GET_base('/activities', '&include_all_efforts=1')
acc_point <- "https://www.strava.com/api/v3"
token <- sig$credentials$access_token
GET_base <- function(resource, parameters){
HTTPreq <- paste(acc_point, resource, '?acces_token=', token, parameters, sep='')
return(fromJSON(HTTPreq))
}
test <- GET_base('/activities', '&include_all_efforts=1')
resource <- '/activities'
parameters <- '&include_all_efforts=1'
paste(acc_point, resource, '?acces_token=', token, parameters, sep='')
library(httr)
library(jsonlite)
# Authorization
my_app <- oauth_app('strava', key='23914', secret='803d437f199924a2ed3f31ff135c84d29b528ca6')
my_endpoint <- oauth_endpoint(
request = NULL,
authorize = "https://www.strava.com/oauth/authorize",
access = "https://www.strava.com/oauth/token"
)
sig <- oauth2.0_token(my_endpoint,
my_app, scope = "view_private",
type = NULL,
use_oob = FALSE,
as_header = FALSE,
use_basic_auth = FALSE,
cache = FALSE)
acc_point <- "https://www.strava.com/api/v3"
token <- sig$credentials$access_token
GET_base <- function(resource, parameters){
HTTPreq <- paste(acc_point, resource, '?acces_token=', token, parameters, sep='')
return(fromJSON(HTTPreq))
}
test <- GET_base('/activities', '&include_all_efforts=1')
jsonData <- fromJSON(paste("https://www.strava.com/api/v3/segments/explore?bounds=47.53853,18.91571,47.48055,19.10797&access_token=",sig$credentials$access_token,sep=''), flatten = TRUE)
jsonData
test
test <- GET_base('/activities', '&include_all_efforts=1')
GET_base('/athlete')
GET_base <- function(resource, parameters=''){
HTTPreq <- paste(acc_point, resource, '?acces_token=', token, parameters, sep='')
return(fromJSON(HTTPreq))
}
GET_base('/athlete')
GET_base <- function(resource, parameters=''){
HTTPreq <- paste(acc_point, resource, '?access_token=', token, parameters, sep='')
return(fromJSON(HTTPreq))
}
GET_base('/athlete')
test <- GET_base('/activities', '&include_all_efforts=1')
test
str(test)
test <- GET_base('/athlete/activities')
test
names(test)
str(test)
test <- GET_base('/activities', '&include_all_efforts=TRUE')
test
test <- GET_base('/activities', '&include_all_efforts=1')
names(test)
test <- GET_base('/athlete/activities')
tet
test
str(test)
test$map$summary_polyline[1]
install.packages('gepaf')
library(gepaf)
poly <- test$map$summary_polyline[1]
str(poly)
decodePolyline(poly)
??leaflet
install.packages('leaflet')
test
View(test)
DT
DT <- t[c('name','distance','moving_time','map.summary_polyline')]
t <- GET_base('/athlete/activities')
DT <- t[c('name','distance','moving_time','map.summary_polyline')]
names(t)
DT <- t[c('name','distance','moving_time','map$summary_polyline')]
View(t)
t[3]$map.summary_polylines
t[3]$map$summary_polylines
DT <- t[c('name','distance','moving_time','mapsummary_polyline')]
t[2]
t[3]
l <- decodePolyline(t[3,]$map$summary_polyline)
l
m <- leaflet()
library(leaflet)
install.packages('leaflet')
?selectInput
library(shiny)
?selectInput
runApp('work/cs_shiny')
runApp('work/cs_shiny')
runApp('work/cs_shiny')
runApp('work/cs_shiny')
token
trans()
input$choice
input$choice
runApp('work/cs_shiny')
runApp('work/cs_shiny')
runApp('work/cs_shiny')
runApp('work/cs_shiny')
runApp('work/cs_shiny')
runApp('work/cs_shiny')
runApp('work/cs_shiny')
runApp('work/cs_shiny')
input$choice
runApp('work/cs_shiny')
runApp('work/cs_shiny')
shiny::runApp('work/cs_shiny')
runApp('work/cs_shiny')
library(shiny)
library(httr)
library(data.table)
library(lubridate)
library(ggplot2)
library(scales)
library(DT)
library(xml2)
# Credentials and access points
API_key="60bcf9f1-34bb-4bd4-aae3-edf5e090c29b"
cli_key="sandboxClientId"
cli_secret="sandboxClientSecret"
authorize_url = "https://webapi.ersteapihub.com/api/csas/sandbox/v1/sandbox-idp/token"
access_url = "https://webapi.ersteapihub.com/api/csas/sandbox/v3/netbanking"
auth <- POST(authorize_url,
body=list(
grant_type="authorization_code",
code="test-code",
client_id=cli_key,
client_secret=cli_secret
),
encode='form',
config=list(
add_headers("Content-Type" = "application/x-www-form-urlencoded"))
)
token <- content(auth)$access_token
token <- paste('Bearer ',token,sep='')
# Credentials
headers <- c(API_key, token)
names(headers) <- c('WEB-API-key','Authorization')
# Get account list
acc <- GET(paste(access_url, '/my/accounts', sep=''),
add_headers(.headers = headers))
acc <- data.frame(content(acc))
acc
names(acc)
acc_list <- data.frame(id=acc$accounts.accountno.cz.iban, name=acc$accounts.productI18N)
acc_list
acc
View(acc)
str(acc)
acc <- GET(paste(access_url, '/my/accounts', sep=''),
add_headers(.headers = headers))
str(acc)
test <- content(acc)
str(test)
test <- content(acc)$accounts
str(test)
acc <- GET(paste(access_url, '/my/accounts', sep=''),
add_headers(.headers = headers))
acc <- content(acc)$accounts
acc_list <- data.table(
id=sapply(acc, function(x){x$accountno$cz-iban}),
product=sapply(acc, function(x){x$productI18N}),
type=sapply(acc, function(x){x$type}),
subtype=sapply(acc, function(x){x$subtype})
)
acc_list <- data.table(
id=sapply(acc, function(x){x$accountno$cz.iban}),
product=sapply(acc, function(x){x$productI18N}),
type=sapply(acc, function(x){x$type}),
subtype=sapply(acc, function(x){x$subtype})
)
acc_list
acc[[1]]
acc_list <- data.table(
id=sapply(acc, function(x){x$accountno$'cz-iban'}),
product=sapply(acc, function(x){x$productI18N}),
type=sapply(acc, function(x){x$type}),
subtype=sapply(acc, function(x){x$subtype})
)
acc_list
acc_list$name <- paste(acc_list$type, acc_list$subtype, sep=' - ')
acc_list
runApp('work/cs_shiny')
acc_list
id <- acc_list[1]$id
id
header
headers
trans <- GET(paste(access_url, '/my/accounts/',id,'/transactions', sep=''),
add_headers(.headers = headers))
str(trans)
trans <- content(trans)
str(trans)
trans
acc_list
Sys.Date()
diff.Date(Sys.Date(), 'year')
?diff.Date
diff.Date(Sys.Date(), 1)
diff.Date(Sys.Date(), lag=1)
Sys.Date()-90
id
datestart <- Sys.Date()-180
dateend <- Sys.Date()
trans <- GET(paste(access_url, '/my/accounts/',id,'/transactions?dateStart=',
datestart,
'&dateEnd=',
dateend,
sep=''),
add_headers(.headers = headers))
trans <- content(trans)$transactions
trans
id
trans <- GET(paste(access_url, '/my/accounts/',id,'/transactions?dateStart=',
datestart,
'&dateEnd=',
dateend,
sep=''),
add_headers(.headers = headers))
trans
GET(paste(access_url, 'cz/my/accounts/',id,'/transactions?dateStart=',
datestart,
'&dateEnd=',
dateend,
sep=''),
add_headers(.headers = headers))
paste(access_url, 'cz/my/accounts/',id,'/transactions?dateStart=',
datestart,
'&dateEnd=',
dateend,
sep='')
GET(paste(access_url, '/cz/my/accounts/',id,'/transactions?dateStart=',
datestart,
'&dateEnd=',
dateend,
sep=''),
add_headers(.headers = headers))
GET(paste(access_url, '/cz/my/accounts/',id,'/transactions?dateStart=',
datestart,
'&dateEnd=',
dateend,
sep='')
)
paste(access_url, '/cz/my/accounts/',id,'/transactions?dateStart=',
datestart,
'&dateEnd=',
dateend,
sep=''),
paste(access_url, '/cz/my/accounts/',id,'/transactions?dateStart=',
datestart,
'&dateEnd=',
dateend,
sep='')
acc_list
runApp('work/cs_shiny')
id
knit_with_parameters('~/work/blog/content/post/test.Rmd')
---
title: "Visualize your Strava activities with Shiny"
author: "Istvan Margitai"
date: '2018-03-23T21:13:14-05:00'
tags:
- Shiny
- Strava
- API
- R
- polylines
categories:
- R
- Shiny
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE)
```
The cycling season started and recently it came into my mind how I can use my Strava data in R to create maps and other visualization about my activities. My goal was to put together a Shiny application with a list of my activities and plot my routes on a map. I started by exploring the Strava API and first of all understand how web APIs work in general. Nowadays we meet quite often with the term RESTful API. What does it mean without going into the details? REST stems for
* __RE__presentational >> Web resources can be accessed and manipulated in textual form. For example in many cases APIs return JSON text files as responses to our requests.
* __S__tate >> Stateless protocol means that the server does not keep information about connection. For example the HTTP protocol is stateless and not interactive contrary to the FTP protocol which is stateful.
* __T__ransfer >> We access the specific web resources under different URLs and use usually HTTP methods (verbs like GET, POST, etc.) to access an modify elements or collections of resources. In our example collections are the set of Strava activities.
For more info about APIs, check [this](https://zapier.com/learn/apis/) great guide from Zapier.
The natural question arise that how REST APIs ensure the access to resources in a secured way. This is where the OAuth buzzword comes. It means Open Authorization protocol, which is used to give delegated access to web resources. Three counterparts are part of this authentication process:
Server >> In our case this is the Strava resource and authentication server
Client >> An application which wants to access the resources, practically this is the Shiny app
User >> The Strava user who "owns" the resources stored on the API server, practically the Strava users
The process starts with the registration of client application on the server. We can do this in our Strava settings under "My API Application". We will receive a Client ID and Client secret. With these two the Strava API can identify our client (the Shiny app). We have to be sure that the client secret is stored in the back end of our Shiny app. One solution is to write it into the .Renviron file, so when the R session starts we can refer to our OAuth credentials as environment variables. We also need to give a name to our application and define a Callback Domain. I run the shiny app on my local computer (so not on a public server) I gave localhost as Callback Domain.
So when the client calls the server and identifies itself with the Client ID and Client secret, the server grants an access token to the client. Now a Strava user opens the Shiny app in its browser and the app directs the user's browser to the Strava authentication page, where the user logs in with his username and password. Then the server redirects the user's browser to the Callback Domain, which is in our case the Shiny app, running on the localhost.
So let's see how we implement this in R step by step.
httr package is a great tool to work with URLs and HTTP verbs and URL query arguments.
?wget
??wget
?download.file
download.file("https://archive.ics.uci.edu/ml/machine-learning-databases/statlog/german/german.data")
download.file("https://archive.ics.uci.edu/ml/machine-learning-databases/statlog/german/german.data", destfile = "german_data.csv")
download.file("https://www.kaggle.com/uciml/german-credit/downloads/german_credit_data.csv", destfile = "german_data.csv")
?read.csc
?read.csv
download.file("https://www.kaggle.com/uciml/german-credit/downloads/german_credit_data.csv", destfile = "german_data.csv")
library{data.table}
library{data.table}
library(data.table)
setwd("/Home/work/blog/data")
library(data.table)
setwd("/home/work/blog/data")
download.file("https://www.kaggle.com/uciml/german-credit/downloads/german_credit_data.csv", destfile = "german_data.csv")
dt <- read.csv("german_data.csv")
head(dt)
sessionInfo()
library(data.table)
library(dplyr)
sessionInfo()
iris2 <- as_tibble(iris)
str(iris2)
iris2
iris2 %>% filter(Species == "setosa")
iris2 %>% arrange()
iris2 %>% arrange(Sepal.Length)
iris2 %>% arrange(desc(Sepal.Length))
iris2 %>% filter(Species = "setosa") %>% arrange(desc(Sepal.Length))
iris2 %>% filter(Species == "setosa") %>% arrange(desc(Sepal.Length))
?select
summarize(iris2)
summarise(iris2)
iris2
group_by(iris2, Species)
iris2
mtcars
select_all(mtcars, toupper
)
cars <- as_tibble(mtcars)
cars
test <- cars %>% group_by(cyl) %>% summarize(avg = mean(hp))
test
test <- data.table(a=c('a','','XNA'))
library(data.table)
test <- data.table(a=c('a','','XNA'))
test
test[, lapply(.SD, function(x) ifelse(x %in% c('','XNA'), NA, x))]
library(data.table)
library(skimr)
library(ggplot2)
library(xgboost)
# Load data -----
# Note: here we assume that the data extraction and integration is
# already done.
dev <- fread('data/application_train.csv', stringsAsFactors = FALSE)
names(dev) <- tolower(names(dev))
descr <- fread('data/HomeCredit_columns_description.csv', stringsAsFactors = FALSE)
# Data exploration
skim_dev <- data.table(skim(dev))
# Quickly explore character variables ----
cols <- unique(skim_dev[skim_dev$type == 'character']$variable)
skim_dev_chr <- data.table()
for(i in cols){
r <- dev[, .(.N), by = i]
names(r)[1] <- "value"
r$var <- i
skim_dev_chr <- rbind(skim_dev_chr, r[,.(var, value, N)])
}
setwd("~/work/credit_api")
library(data.table)
library(skimr)
library(ggplot2)
library(xgboost)
# Load data -----
# Note: here we assume that the data extraction and integration is
# already done.
dev <- fread('data/application_train.csv', stringsAsFactors = FALSE)
names(dev) <- tolower(names(dev))
descr <- fread('data/HomeCredit_columns_description.csv', stringsAsFactors = FALSE)
# Data exploration
skim_dev <- data.table(skim(dev))
# Quickly explore character variables ----
cols <- unique(skim_dev[skim_dev$type == 'character']$variable)
skim_dev_chr <- data.table()
for(i in cols){
r <- dev[, .(.N), by = i]
names(r)[1] <- "value"
r$var <- i
skim_dev_chr <- rbind(skim_dev_chr, r[,.(var, value, N)])
}
cols
dev[, (cols) := lapply(.SD, function(x) ifelse(x %in% c('','XNA'), NA, x))
, .SDcols = cols]
skim(dev)
rm(c(r, cols))
rm(c('r', 'cols'))
rm('r', 'cols')
View(descr)
View(descr)
class(descr)
desc[substr(Row,1,4) == 'FLAG' | gsub('Flag', Row),]
descr[substr(Row,1,4) == 'FLAG' | gsub('Flag', Row),]
?gsub
descr[substr(Row,1,4) == 'FLAG' | gsub('flag', Row, ignore.case = TRUE),]
descr[substr(Row,1,4) == 'FLAG' | gsub("flag", Description, ignore.case = TRUE),]
descr[substr(Row,1,4) == 'FLAG' | gsub("flag", Description, ignore.case = TRUE),]
descr[substr(Row,1,4) == 'FLAG' | gsub("flag", Description, ignore.case = TRUE),]
gsub("flag", descr$Description, ignore.case = TRUE)
grep("flag", descr$Description, ignore.case = TRUE)
descr[substr(Row,1,4) == 'FLAG' | grep("flag", Description, ignore.case = TRUE),]
descr[substr(Row,1,4) == 'FLAG' | grep("flag", Description, ignore.case = TRUE, useBytes = T),]
descr[substr(Row,1,4) == 'FLAG',]
cols <- names(dev)[substr(names(dev),1,4) == 'flag']
cols
test <- dev[, cols, with=T]
test <- dev[, (cols), with=T]
test
test <- dev[, (cols), with=F]
test
dev$flag_own_car <- ifelse(dev$flag_own_car == 'N', 0, 1)
dev$flag_own_realty <- ifelse(dev$flag_own_realty == 'N', 0, 1)
test <- dev[, (cols), with=F]
test
skim(test)
descr(substr(escription,1,4) == 'Flag',]
descr[substr(escription,1,4) == 'Flag',]
descr[substr(Description,1,4) == 'Flag',]
cols <- descr[substr(Row,1,4) == 'flag' | substr(Description,1,4) == 'Flag',]
cols
# Some of them are flags while others are counters
# Let's identify first the flag variables using the metatdata descr
cols <- descr[substr(Row,1,4) == 'FLAG' | substr(Description,1,4) == 'Flag',]
cols
View(skim_dev)
skim(dev[, (cols), with=F])
skim(dev[, (cols), with=T])
# Some of them are flags while others are counters
# Let's identify first the flag variables using the metatdata descr
cols <- tolow(descr[substr(Row,1,4) == 'FLAG' | substr(Description,1,4) == 'Flag',]$Row)
# Some of them are flags while others are counters
# Let's identify first the flag variables using the metatdata descr
cols <- tolower(descr[substr(Row,1,4) == 'FLAG' | substr(Description,1,4) == 'Flag',]$Row)
skim(dev[, (cols), with=T])
skim(dev[, (cols), with=F])
cols <- tolower(descr[substr(Row,1,4) == 'FLAG'
| substr(Description,1,4) == 'Flag'
| Talbe = 'application_{train|test}.csv'
,]$Row)
cols <- tolower(descr[substr(Row,1,4) == 'FLAG'
| substr(Description,1,4) == 'Flag'
| Table == 'application_{train|test}.csv'
,]$Row)
cols
cols <- tolower(descr[(substr(Row,1,4) == 'FLAG'
| substr(Description,1,4) == 'Flag')
& Table == 'application_{train|test}.csv'
,]$Row)
skim(dev[, (cols), with=F])
